name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  FORCE_COLOR: 1
  PYTHONUNBUFFERED: 1

jobs:
  # Code Quality Checks
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        cache: "pip"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Check code formatting (Black)
      run: black --check --diff .
    
    - name: Lint code (Ruff)
      run: ruff check .
    
    - name: Check imports (isort)
      run: ruff check --select I .
    
    - name: Type checking (MyPy)
      run: mypy core/ rendering/
      continue-on-error: true  # Allow type errors for now
    
    - name: Security scan (Bandit)
      run: |
        pip install bandit
        bandit -r core/ rendering/ -f json -o bandit-report.json || true
        bandit -r core/ rendering/
    
    - name: Upload security report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-report
        path: bandit-report.json

  # Unit Tests
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: "pip"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Run unit tests
      run: |
        pytest tests/ -v \
          --cov=core \
          --cov=rendering \
          --cov-report=xml \
          --cov-report=html \
          --cov-fail-under=80
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      if: matrix.python-version == '3.11'
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  # Game Engine Tests
  engine-test:
    name: Engine Integration Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        cache: "pip"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Test game initialization
      run: |
        python -c "from core import GameState; print('✅ Core module import successful')"
        python -c "from rendering import PyGameRenderer; print('✅ Renderer import successful')"
        python -c "from main import Game; print('✅ Main game import successful')"
    
    - name: Test game state operations
      run: |
        python -c "
        from core import GameState
        from core.entities.player import create_player
        
        # Test game state creation
        game_state = GameState(map_width=10, map_height=10)
        game_state.initialize()
        print('✅ Game state initialization successful')
        
        # Test player creation
        player = create_player(5, 5, 0)
        print('✅ Player creation successful')
        "
    
    - name: Test tile map operations
      run: |
        python -c "
        from core.world.tile_map import TileMap
        from core.world.terrain import TERRAIN_REGISTRY
        
        # Test tile map operations
        tile_map = TileMap(10, 10, 'wasteland_dirt')
        tile_map.set_tile(5, 5, 'rubble')
        tile = tile_map.get_tile(5, 5)
        assert tile.tile_type.id == 'rubble'
        print('✅ Tile map operations successful')
        "

  # Documentation Build
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        cache: "pip"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[docs]"
        pip install -e ".[dev]"
    
    - name: Generate documentation
      run: |
        # Check that all modules can be imported
        python -m pydoc -w core
        python -m pydoc -w rendering
        echo "✅ Documentation generation successful"
    
    - name: Check docstring coverage
      run: |
        python -c "
        import ast
        import os
        
        def check_docstrings(directory):
            for root, dirs, files in os.walk(directory):
                for file in files:
                    if file.endswith('.py') and not file.startswith('test_'):
                        filepath = os.path.join(root, file)
                        with open(filepath, 'r') as f:
                            try:
                                tree = ast.parse(f.read())
                                for node in ast.walk(tree):
                                    if isinstance(node, (ast.FunctionDef, ast.ClassDef, ast.AsyncFunctionDef)):
                                        if not ast.get_docstring(node):
                                            print(f'Missing docstring: {filepath}:{node.lineno} - {node.name}')
                            except:
                                pass
        
        check_docstrings('core')
        check_docstrings('rendering')
        "

  # Performance Tests
  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        cache: "pip"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
        pip install memory-profiler psutil
    
    - name: Run performance tests
      run: |
        python -c "
        import time
        import psutil
        import os
        from core import GameState
        from rendering import PyGameRenderer
        
        # Test game state performance
        start_time = time.time()
        game_state = GameState(map_width=100, map_height=100)
        game_state.initialize()
        init_time = time.time() - start_time
        
        # Test memory usage
        process = psutil.Process(os.getpid())
        memory_mb = process.memory_info().rss / 1024 / 1024
        
        print(f'Game state initialization: {init_time:.3f}s')
        print(f'Memory usage: {memory_mb:.1f} MB')
        
        # Performance thresholds
        assert init_time < 1.0, f'Initialization too slow: {init_time:.3f}s'
        assert memory_mb < 100, f'Memory usage too high: {memory_mb:.1f} MB'
        
        print('✅ Performance tests passed')
        "

  # Build and Release
  build:
    name: Build and Release
    runs-on: ubuntu-latest
    needs: [quality, test, engine-test, docs]
    if: github.event_name == 'release'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        cache: "pip"
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build wheel setuptools_scm
    
    - name: Build distribution
      run: |
        python -m build
    
    - name: Check distribution
      run: |
        pip install dist/*.whl
        python -c "import IsoTalia; print('✅ Distribution check successful')"
    
    - name: Create archive
      run: |
        cd dist
        tar -czf ../IsoTalia-${{ github.event.release.tag_name }}.tar.gz *.whl
        cd ..
    
    - name: Upload release assets
      uses: actions/upload-artifact@v4
      with:
        name: release-assets
        path: IsoTalia-*.tar.gz
    
    - name: Upload to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        pip install twine
        twine upload dist/* --verbose

  # Notification
  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [quality, test, engine-test, docs]
    if: always()
    
    steps:
    - name: Send notification
      run: |
        if [[ "${{ needs.quality.result }}" == "success" && 
              "${{ needs.test.result }}" == "success" && 
              "${{ needs.engine-test.result }}" == "success" && 
              "${{ needs.docs.result }}" == "success" ]]; then
          echo "✅ All CI/CD checks passed!"
        else
          echo "❌ Some CI/CD checks failed:"
          echo "Quality: ${{ needs.quality.result }}"
          echo "Tests: ${{ needs.test.result }}"
          echo "Engine: ${{ needs.engine-test.result }}"
          echo "Docs: ${{ needs.docs.result }}"
          exit 1
        fi