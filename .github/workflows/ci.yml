name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  FORCE_COLOR: 1
  PYTHONUNBUFFERED: 1

jobs:
  # Code Quality Checks
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        cache: "pip"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Check code formatting (Black)
      run: black --check --diff .
    
    - name: Lint code (Ruff)
      run: ruff check .
    
    - name: Type checking (MyPy)
      run: mypy core/ rendering/
      continue-on-error: true
    
    - name: Security scan (Bandit)
      run: |
        pip install bandit
        bandit -r core/ rendering/ -f json -o bandit-report.json || true

  # Unit Tests
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: "pip"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Run unit tests
      run: |
        pytest tests/ -v \
          --cov=core \
          --cov=rendering \
          --cov-report=xml \
          --cov-report=html \
          --cov-fail-under=80

  # Game Engine Tests
  engine-test:
    name: Engine Integration Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        cache: "pip"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Test game initialization
      run: |
        python -c "from core import GameState; print('✅ Core module import successful')"
        python -c "from rendering import PyGameRenderer; print('✅ Renderer import successful')"
        python -c "from main import Game; print('✅ Main game import successful')"
    
    - name: Test game state operations
      run: |
        python -c "
        from core import GameState
        from core.entities.player import create_player
        
        # Test game state creation
        game_state = GameState(map_width=10, map_height=10)
        game_state.initialize()
        print('✅ Game state initialization successful')
        
        # Test player creation
        player = create_player(5, 5, 0)
        print('✅ Player creation successful')
        "
    
    - name: Test tile map operations
      run: |
        python -c "
        from core.world.tile_map import TileMap
        from core.world.terrain import TERRAIN_REGISTRY
        
        # Test tile map operations
        tile_map = TileMap(10, 10, 'wasteland_dirt')
        tile_map.set_tile(5, 5, 'rubble')
        tile = tile_map.get_tile(5, 5)
        assert tile.tile_type.id == 'rubble'
        print('✅ Tile map operations successful')
        "

  # Build and Release
  build:
    name: Build and Release
    runs-on: ubuntu-latest
    needs: [quality, test, engine-test]
    if: github.event_name == 'release'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        cache: "pip"
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build wheel
    
    - name: Build distribution
      run: |
        python -m build
    
    - name: Check distribution
      run: |
        pip install dist/*.whl
        python -c "import IsoTalia; print('✅ Distribution check successful')"